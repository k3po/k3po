#
# Copyright 2007-2015, Kaazing Corporation. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

property location 'http://localhost:8080/echo'
accept ${location}
accepted
connected

read method "GET"
read version "HTTP/1.1"
read header "Host" "localhost:8080"
read header "Upgrade" /(?i:websocket)/
read header "Connection" /(?i:Upgrade)/
read header "Sec-WebSocket-Key" /(?<key>[a-zA-Z0-9+\/=]{24})/
read header "Sec-WebSocket-Version" "13"

write status "401" "Unauthorized"
write header "WWW-Authenticate" "Basic realm=\"demo\" saml-authn-request=\"PHNhbWxwOkF1dGhuUmVxdWVzdCB4bWxuczpzYW1scD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnByb3RvY29sIiB4bWxuczpzYW1sPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIiBJRD0icGZ4NDFkOGVmMjItZTYxMi04YzUwLTk5NjAtMWIxNmYxNTc0MWIzIiBWZXJzaW9uPSIyLjAiIFByb3ZpZGVyTmFtZT0iU1AgdGVzdCIgSXNzdWVJbnN0YW50PSIyMDE0LTA3LTE2VDIzOjUyOjQ1WiIgRGVzdGluYXRpb249Imh0dHA6Ly9pZHAuZXhhbXBsZS5jb20vU1NPU2VydmljZS5waHAiIFByb3RvY29sQmluZGluZz0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmJpbmRpbmdzOkhUVFAtUE9TVCIgQXNzZXJ0aW9uQ29uc3VtZXJTZXJ2aWNlVVJMPSJodHRwOi8vc3AuZXhhbXBsZS5jb20vZGVtbzEvaW5kZXgucGhwP2FjcyI+IDxzYW1sOklzc3Vlcj5odHRwOi8vc3AuZXhhbXBsZS5jb20vZGVtbzEvbWV0YWRhdGEucGhwPC9zYW1sOklzc3Vlcj4gPGRzOlNpZ25hdHVyZSB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+IDxkczpTaWduZWRJbmZvPjxkczpDYW5vbmljYWxpemF0aW9uTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8+IDxkczpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjcnNhLXNoYTEiLz4gPGRzOlJlZmVyZW5jZSBVUkk9IiNwZng0MWQ4ZWYyMi1lNjEyLThjNTAtOTk2MC0xYjE2ZjE1NzQxYjMiPjxkczpUcmFuc2Zvcm1zPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIvPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48L2RzOlRyYW5zZm9ybXM+PGRzOkRpZ2VzdE1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNzaGExIi8+PGRzOkRpZ2VzdFZhbHVlPnlKTjZjWFV3UXhUbU1Fc1Blc0JQMk5rcVlGST08L2RzOkRpZ2VzdFZhbHVlPjwvZHM6UmVmZXJlbmNlPiA8L2RzOlNpZ25lZEluZm8+IDxkczpTaWduYXR1cmVWYWx1ZT5nNWVNOXlQbktzbW1FL0toMnFTN25mSzhIb0Y2eUhyQWROUXhoNzBraDhwUkk0S2FOYllOT0w5c0Y4RjU3WWQrak82aU5nYThubmJ3aGJBVEtHWElaT0pKU3VnWEdBTVJ5WnNqL3Jxbmd3VEprNUttdWpicW91UjFTTEZzYm83SXV3emU5MzNFZ2VmQmJBRTRKUkk3VjJhRDlZZ21CM3NvY1BxQWkyUWY5N0U9PC9kczpTaWduYXR1cmVWYWx1ZT4gPGRzOktleUluZm8+PGRzOlg1MDlEYXRhPjxkczpYNTA5Q2VydGlmaWNhdGU+TUlJQ2FqQ0NBZE9nQXdJQkFnSUJBREFOQmdrcWhraUc5dzBCQVFRRkFEQlNNUXN3Q1FZRFZRUUdFd0oxY3pFVE1CRUdBMVVFQ0F3S1EyRnNhV1p2Y201cFlURVZNQk1HQTFVRUNnd01UMjVsYkc5bmFXNGdTVzVqTVJjd0ZRWURWUVFEREE1emNDNWxlR0Z0Y0d4bExtTnZiVEFlRncweE5EQTNNVGN3TURJNU1qZGFGdzB4TlRBM01UY3dNREk1TWpkYU1GSXhDekFKQmdOVkJBWVRBblZ6TVJNd0VRWURWUVFJREFwRFlXeHBabTl5Ym1saE1SVXdFd1lEVlFRS0RBeFBibVZzYjJkcGJpQkpibU14RnpBVkJnTlZCQU1NRG5Od0xtVjRZVzF3YkdVdVkyOXRNSUdmTUEwR0NTcUdTSWIzRFFFQkFRVUFBNEdOQURDQmlRS0JnUUM3dlUvNlIvT0JBNkJLc1pINEwyYklRMmNxQk83L2FNZlBqVVBKUFNuNTlkL2YwYVJxU0M1OFlZclB1UU9EeWRVQUJpQ2tuT245eVYwZkVZbTRiTnZmanJvVEVkOGJEbHFvNW9BWEFVQUk4WEhQcHBKTno3cHhiaFpXMHUzNXE0NVBKekdNOW5DdjliZ2xEUVlKTGJ5MVpVZEhzU2lESXBNYkdnZi9acnhxYXdJREFRQUJvMUF3VGpBZEJnTlZIUTRFRmdRVTNzMk5FcFl4N3dINmJxN3hKRkthNDZqQkRmNHdId1lEVlIwakJCZ3dGb0FVM3MyTkVwWXg3d0g2YnE3eEpGS2E0NmpCRGY0d0RBWURWUjBUQkFVd0F3RUIvekFOQmdrcWhraUc5dzBCQVFRRkFBT0JnUUNQc05PMkZHK3ptazVtaVhFc3dBczMwRTE0ckJKcGUvNjRGQnBNMXJQek9sZWV4dk1nWmxyMC9zbUYzUDVUV2I3SDhGeTVrRWlCeXhNamFRbW1sL25ReDZxZ1ZWemRoYVRBTnBJRTF5d0V6VkpsaGR2dzRobVJ1RUtZcVRhRk1MZXowc1JMNzlMVWVEeFBXdzdNajlGa3BSWVQra0FHaUZvbUhvcDFuRXJWNlE9PTwvZHM6WDUwOUNlcnRpZmljYXRlPjwvZHM6WDUwOURhdGE+PC9kczpLZXlJbmZvPiA8L2RzOlNpZ25hdHVyZT4gPHNhbWxwOk5hbWVJRFBvbGljeSBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjEuMTpuYW1laWQtZm9ybWF0OmVtYWlsQWRkcmVzcyIgQWxsb3dDcmVhdGU9InRydWUiLz4gPHNhbWxwOlJlcXVlc3RlZEF1dGhuQ29udGV4dCBDb21wYXJpc29uPSJleGFjdCI+IDxzYW1sOkF1dGhuQ29udGV4dENsYXNzUmVmPnVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphYzpjbGFzc2VzOlBhc3N3b3JkUHJvdGVjdGVkVHJhbnNwb3J0PC9zYW1sOkF1dGhuQ29udGV4dENsYXNzUmVmPiA8L3NhbWxwOlJlcXVlc3RlZEF1dGhuQ29udGV4dD4gPC9zYW1scDpBdXRoblJlcXVlc3Q+\""
write close

accepted
connected

read method "GET"
read version "HTTP/1.1"
read header "Host" ${location}
read header "Upgrade" /(?i:websocket)/
read header "Connection" /(?i:Upgrade)/
read header "Sec-WebSocket-Key" /(?<key>[a-zA-Z0-9+\/=]{24})/
read header "Sec-WebSocket-Version" "13"
read header "Authorization" "Basic realm=\"demo\" saml-authn-request=\"7VfLcuI6EN2nKv/g8ixTYMsYcFwDUzyDwzMYAsnmlrBkI+IXlgyErx+ZV5yEPObWXdzFrCja3a1zultH0s9fG88VVjiiJPBLIsjKooB9K0DEd0rieNTMaOKv8k8KPVcJ9SGmYeBTLPAgn+p7a0mMI18PICVU96GHqc4s3ax0O7qSlfUwClhgBa54iNlQVBLnjIW6JK3X6+w6lw0iR1JkGUjTbse05tiDolDHlBEfsh2qg/sThFsOK4s30AtdnLUCTxSMekn8Zybnri1FnV2j6+IMzPJyARa1vA01nC9YEGncjdIYGz5l0GclUZFBIQOUjKyNQEFXFR3I2ZwGHkXh/lgJjl0sX17smeu78ChN+3PWkFIcJeDF8gE8QWEa+E8pnThZCFHdJA6nHEfH+iL6QalkSb6WuA+ixPkhpqIxMnw7OBhq0A98YkGXbHeF7GI2D5BQcZ0gImzunUs+Gu5bMWzUMnyBjAVUP5NY5BzIi9JboN9J+RZvRGGGziE4ZRtiG0d86LAwHhol8cfX7TwEjiLoUzuIPPrW8GeIsL/CbhBilKFHYidw308JJCAnKTN4Y+3qtu8MtnTDt9yYkhXuJYMSQgvTQ4ex9f1kwiDCNtl0COUTzLfRHqKUxvjOcCxMnTh8Q32zW0CS1WRt3pIfvFFKvnCqxj7PPXRjXH52vee7DjSuW0XtwfHMylNuYajmhrqTwXDihI3HO+9qeL1QR1pphyodfAB6av3R8G6IT6N2jDOqDT4UsIDUTU6tL0FDKcSVeWHAzLUzY8Vic8S026tt5aFbnHXl2LdlH1Xn26VmP3Tb/dnUyXnjzVW/Vtu2ppcX5nYVLp1ZPxd4iza4onftem9wr42398vCVtJMPMhDebIhkKBiPQbx010z77Wrq9Wy2cBoE4TXDYV153C2CYqXF1fOyLiRDLdDW32YG3hPA6eUIvaKx2vrSWpC3WTcQt8ZagHCwi64JJqxxWeIHibgfJxeOWrQv5Gtva4CSwYqLNqagu28rAK+ag5rmlbM56CVV/B3dFVVcl/p6l+N/HON/LI1fzXyf6CRk/tOlwZzbVQzHCxPCLFv+sUYrS0/V7ADhh4Gs9wWjJ8aHfW/1MgnpxkOXbi9Cre9Z3Xd6o/bwaI7HbmLyVN9EZiPt7ft6Z09NVthUwEP9WGsqr25WfGLk8fexMoPR3OpUVOIE05WlxdOAO6dSg0tb9Bz9TlQmiySxnS5WOTbxQ0cVrsVs06rdzhCU+2uFTWW27o5Ard+vXJjTNgC1Hrb+9aqqpKaAS4vlP7UcqlG6Cb/qIFiYdp7+FON1M14tsAWezEkQ2PUhSZvJ2QfaxzIgp2FoIy9c9X5ZZO4FYSiRE7LXEJ9BCMktPdXTWHM9fAoQ/s13oGoBb5NklyJ0u6n53ORtTx9hmGEI/HTXHXIoNALWN/vRxWb4ehFXoEyklVdTl1bh9giIcGJBn9yWU4dF+dWfP/1BSD3QyRxogmmKublw5/p/TeBp06rGJFkyPkTg0XEOuJ5/bH8Mbkj8pPrC5kPUktvmaXXY3M/OU+xx2sq7P5+ccjlX5PhATwxwxt23lpz+VnLd3b50+PY0q3Ej5sH/GcdROiF05lcacqvAUjneKWQMV6YWczwZ9+EZAPw0eZbIoEqnnHZ7dvTQ498/dDLkF1VLX6T4P46ew7xTrf1pFO+I5Yr41GrPzQeG/UTh1eLpckdP5yzvSImvbkgpW9Rxycut/0G\""

write status "101" "Switching Protocols"
write version "HTTP/1.1"
write header "Upgrade" "websocket"
write header "Connection" "Upgrade"
write header "Sec-WebSocket-Accept" ${ws:handshakeHash(key)}

read [0x82 0x7d]
read [0..125]

write [0x88 0x02 0x03 0xea]