#
# Copyright 2007-2015, Kaazing Corporation. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

property acceptLocation "http://localhost:8001/amqp"
property validCredentials ${ws:base64Encode("joe:welcome")} #am9lOndlbGNvbWU=
property authHeader ${ws:append("Basic ", validCredentials)}
property webSocketExtensionHeader "test"

accept ${acceptLocation}
accepted
connected

read method "GET"
read version "HTTP/1.1"
read header "Host" "localhost:8001"
read header "Upgrade" /(?i:websocket)/
read header "Connection" /(?i:Upgrade)/
read header "Sec-WebSocket-Key" /(?<key>[a-zA-Z0-9+\/=]{24})/
read header "Sec-WebSocket-Version" "13"
read header "Authorization" ${authHeader}
write header "Sec-WebSocket-Extensions" ${webSocketExtensionHeader}

write status "101" "Switching Protocols"
write version "HTTP/1.1"
write header "Upgrade" "websocket"
write header "Connection" "Upgrade"
write header "Sec-WebSocket-Accept" ${ws:handshakeHash(key)}
write header "Sec-WebSocket-Extensions" ${webSocketExtensionHeader}

# AMQP
read [0x82 0x88] ([0..4] :readMask)
read option mask ${readMask}
read [0x41 0x4D 0x51 0x50 0x00 0x00 0x09 0x01]
read option mask [0x00 0x00 0x00 0x00]

# AmqpStart AMQPLAIN PLAIN CRAM-MD5 en_US 
write [0x82 0x36]
write [0x01 0x00 0x00 0x00 0x00 0x00 0x2e 0x00 0x0a 0x00 0x0a 0x00 0x09 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x17 0x41 0x4d 0x51 0x50 0x4c 0x41 0x49 0x4e 0x20 0x50 0x4c 0x41 0x49 0x4e 0x20 0x43 0x52 0x41 0x4d 0x2d 0x4d 0x44 0x35 0x00 0x00 0x00 0x05 0x65 0x6e 0x5f 0x55 0x53 0xce] 

# AmqpStartOK message
# library KaazingAmqpClient library_versionS 4.0.6 library_platform CNJavaScript AMQPLAIN LOGINS guest PASSWORDS guest en_US
read [0x82 0xfe 0x00 0x94] ([0..4] :readMask)
read option mask ${readMask}
read [0x01 0x00 0x00 0x00 0x00 0x00 0x8C 0x00 0x0A 0x00 0x0B 0x00 0x00 0x00 0x58 0x07 0x6C 0x69 0x62 0x72 0x61 0x72 0x79 0x53]
read [0x00 0x00 0x00 0x11 0x4B 0x61 0x61 0x7A 0x69 0x6E 0x67 0x41 0x6D 0x71 0x70 0x43 0x6C 0x69 0x65 0x6E 0x74 0x0F 0x6C 0x69]
read [0x62 0x72 0x61 0x72 0x79 0x5F 0x76 0x65 0x72 0x73 0x69 0x6F 0x6E 0x53 0x00 0x00 0x00 0x05 0x34 0x2E 0x30 0x2E 0x36 0x10]
read [0x6C 0x69 0x62 0x72 0x61 0x72 0x79 0x5F 0x70 0x6C 0x61 0x74 0x66 0x6F 0x72 0x6D 0x53 0x00 0x00 0x00 0x0A 0x4A 0x61 0x76]
read [0x61 0x53 0x63 0x72 0x69 0x70 0x74 0x08 0x41 0x4D 0x51 0x50 0x4C 0x41 0x49 0x4E 0x00 0x00 0x00 0x19 0x05 0x4C 0x4F 0x47]
read [0x49 0x4E 0x53 0x00 0x00 0x00 0x00 0x08 0x50 0x41 0x53 0x53 0x57 0x4F 0x52 0x44 0x53 0x00 0x00 0x00 0x00 0x05 0x65 0x6E 0x5F 0x55 0x53 0xCE]
read option mask [0x00 0x00 0x00 0x00]

# AmqpTuneOkMessage
write [0x82 0x14]
write [0x01 0x00 0x00 0x00 0x00 0x00 0x0C 0x00 0x0A 0x00 0x1E 0x01 0x00 0x00 0x00 0xFF 0xFF 0x00 0x00 0xCE]

read [0x82 0x94] ([0..4] :readMask)
read option mask ${readMask}
read [0x01 0x00 0x00 0x00 0x00 0x00 0x0C 0x00 0x0A 0x00 0x1F 0x01 0x00 0x00 0x00 0xFF 0xFF 0x00 0x00 0xCE]
read option mask [0x00 0x00 0x00 0x00]

# AmqpOpenMessage
read [0x82 0x90] ([0..4] :readMask)
read option mask ${readMask}
read [0x01 0x00 0x00 0x00 0x00 0x00 0x08 0x00 0x0A 0x00 0x28 0x01 0x2F 0x00 0x00 0xCE]
read option mask [0x00 0x00 0x00 0x00]

# AmqpOpenOkMessage
write [0x82 0x0e]
write [0x01 0x00 0x00 0x00 0x00 0x00 0x06 0x00 0x0A 0x00 0x29 0x01 0x2F 0xCE]



